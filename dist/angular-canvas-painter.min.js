"use strict";!function(e){angular.module("pw.canvas-painter",[]),function(e){try{e=angular.module("pw.canvas-painter")}catch(t){e=angular.module("pw.canvas-painter",[])}e.run(["$templateCache",function(e){e.put("../templates/canvas.html",'<div class="pwCanvasPaint" style="position:relative"></div>')}])}(),function(e){try{e=angular.module("pw.canvas-painter")}catch(t){e=angular.module("pw.canvas-painter",[])}e.run(["$templateCache",function(e){e.put("../templates/color-selector.html",'<ul class="pwColorSelector"><li ng-repeat="color in colorList track by $index" class="pwColor" ng-class="{\'active\': (selectedColor === color)}" ng-style="{\'background-color\':color}" ng-click="setColor(color)"></li></ul>')}])}(),angular.module("pw.canvas-painter").directive("pwCanvas",["$timeout",function(t){return{restrict:"AE",scope:{options:"=",version:"="},templateUrl:"../templates/canvas.html",link:function(n,o){var a=!!("ontouchstart"in e),i=a?"touchstart":"mousedown",r=a?"touchmove":"mousemove",c=a?"touchend":"mouseup",l=n.options;l.canvasId=l.customCanvasId||"pwCanvasMain",l.tmpCanvasId=l.customCanvasId?l.canvasId+"Tmp":"pwCanvasTmp",l.width=l.width||400,l.height=l.height||300,l.backgroundColor=l.backgroundColor||"#fff",l.color=l.color||"#000",l.undoEnabled=l.undoEnabled||!1,l.opacity=l.opacity||.9,l.lineWidth=l.lineWidth||1,l.undo=l.undo||!1,l.imageSrc=l.imageSrc||!1,l.resize=l.resize||!1;var s=document.createElement("canvas");s.id=l.canvasId;var u=document.createElement("canvas");u.id=l.tmpCanvasId,angular.element(u).css({position:"absolute",top:0,left:0}),o.find("div").append(s),o.find("div").append(u);var d=s.getContext("2d"),h=u.getContext("2d"),p={x:0,y:0},v=[],f=function(){if(l.resize&&(l.height=o.height(),l.width=o.width()),s.width=u.width=l.width,s.height=u.height=l.height,l.imageSrc){var e=new Image;e.onload=function(){d.drawImage(this,0,0)},e.src=l.imageSrc}d.fillStyle=l.backgroundColor,d.fillRect(0,0,s.width,s.height),h.globalAlpha=l.opacity,h.lineJoin=h.lineCap="round",h.lineWidth=l.lineWidth,h.strokeStyle=l.color};t(function(){f()}),n.$watch("options.lineWidth",function(e){"string"==typeof e&&(e=parseInt(e,10)),e&&"number"==typeof e&&(h.lineWidth=l.lineWidth=e)}),n.$watch("options.color",function(e){e&&(h.strokeStyle=h.fillStyle=e)}),n.$watch("options.opacity",function(e){e&&(h.globalAlpha=e)});var m=function(e){var t=0,n=0;do isNaN(e.offsetLeft)||(t+=e.offsetTop,n+=e.offsetLeft),e=e.offsetParent;while(e);return{left:n,top:t}},g=function(e,t){a?(e.x=t.changedTouches[0].pageX-m(t.target).left,e.y=t.changedTouches[0].pageY-m(t.target).top):(e.x=void 0!==t.offsetX?t.offsetX:t.layerX,e.y=void 0!==t.offsetY?t.offsetY:t.layerY)},y=function(e){if(e&&(e.preventDefault(),g(p,e)),v.push({x:p.x,y:p.y}),3===v.length){var t=v[0];return h.beginPath(),h.arc(t.x,t.y,h.lineWidth/2,0,2*Math.PI,!0),h.fill(),h.closePath(),void 0}h.clearRect(0,0,u.width,u.height),h.beginPath(),h.moveTo(v[0].x,v[0].y);for(var n=1;n<v.length-2;n++){var o=(v[n].x+v[n+1].x)/2,a=(v[n].y+v[n+1].y)/2;h.quadraticCurveTo(v[n].x,v[n].y,o,a)}h.quadraticCurveTo(v[n].x,v[n].y,v[n+1].x,v[n+1].y),h.stroke()},w=function(){l.undo&&n.$apply(function(){E.push(d.getImageData(0,0,u.width,u.height)),angular.isNumber(l.undo)&&l.undo>0&&(E=E.slice(-1*l.undo))}),u.removeEventListener(r,y,!1),d.drawImage(u,0,0),h.clearRect(0,0,u.width,u.height),v=[]},C=function(e){e.preventDefault(),u.addEventListener(r,y,!1),g(p,e),v.push({x:p.x,y:p.y}),v.push({x:p.x,y:p.y}),y()},x=function(){function e(){s=!0}function t(){s=!1}function o(){document.body.removeEventListener("mousedown",e),document.body.removeEventListener("mouseup",t)}function r(e){s&&C(e)}function l(e){s&&w(e)}if(u.addEventListener(i,C,!1),u.addEventListener(c,w,!1),!a){var s;document.body.addEventListener("mousedown",e),document.body.addEventListener("mouseup",t),n.$on("$destroy",o),u.addEventListener("mouseenter",r),u.addEventListener("mouseleave",l)}},b=function(e){E.length>0&&(d.putImageData(E[e],0,0),E=E.slice(0,e))};if(l.undo){var E=[];n.$watch(function(){return E.length},function(e){n.version=e}),n.$watch("version",function(e){return 0>e?(n.version=0,void 0):e>=E.length?(n.version=E.length,void 0):(b(e),void 0)})}x()}}}]),angular.module("pw.canvas-painter").directive("pwColorSelector",function(){return{restrict:"AE",scope:{colorList:"=pwColorSelector",selectedColor:"=color"},templateUrl:"../templates/color-selector.html",link:function(e){e.setColor=function(t){e.selectedColor=t}}}})}(this);